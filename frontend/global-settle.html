<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Global Settlements</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    rel="stylesheet" />
  <!-- Bootstrap Icons for existing JS icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4A90E2",
            "background-light": "#f5f7f8",
            "background-dark": "#101922",
            "positive": "#50E3C2",
            "negative": "#F5A623",
            "text-light-primary": "#1C1C1E",
            "text-light-secondary": "#8E8E93",
            "text-dark-primary": "#F2F2F7",
            "text-dark-secondary": "#8E8E93",
            "border-light": "#E5E5EA",
            "border-dark": "#3A3A3C",
            "surface-light": "#FFFFFF",
            "surface-dark": "#1C1C1E"
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "1rem",
            "xl": "1.5rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 1,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }

    /* Toast Container for Notifications */
    #toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      padding: 1rem;
      border-radius: 0.5rem;
      color: white;
      animation: slideIn 0.3s ease-out;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .bg-danger {
      background-color: #ef4444;
    }

    .bg-success {
      background-color: #22c55e;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body
  class="font-display bg-background-light dark:bg-background-dark text-text-light-primary dark:text-text-dark-primary">

  <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
      <div class="px-4 sm:px-8 md:px-16 lg:px-24 xl:px-40 flex flex-1 justify-center py-5">
        <div class="layout-content-container flex flex-col w-full max-w-7xl flex-1">

          <!-- TopNavBar -->
          <header
            class="flex items-center justify-between whitespace-nowrap border-b border-solid border-border-light dark:border-border-dark px-6 py-4 rounded-xl bg-surface-light dark:bg-surface-dark">
            <div class="flex items-center gap-4">
              <div class="size-6 text-primary">
                <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                  <g clip-path="url(#clip0_6_319)">
                    <path
                      d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z"
                      fill="currentColor"></path>
                  </g>
                  <defs>
                    <clippath id="clip0_6_319">
                      <rect fill="white" height="48" width="48"></rect>
                    </clippath>
                  </defs>
                </svg>
              </div>
              <h2 class="text-text-light-primary dark:text-text-dark-primary text-xl font-bold leading-tight">SettleApp
              </h2>
            </div>
            <div class="hidden md:flex items-center gap-9">
              <a class="text-text-light-primary dark:text-text-dark-primary text-sm font-medium leading-normal"
                href="Home.html">. Home</a>
              <a class="text-text-light-primary dark:text-text-dark-primary text-sm font-medium leading-normal"
                href="groups.html">Groups</a>
              <a class="text-text-light-primary dark:text-text-dark-primary text-sm font-medium leading-normal"
                href="friends.html">Friends</a>
              <a class="text-text-light-primary dark:text-text-dark-primary text-sm font-medium leading-normal"
                href="stats.html">Activity</a>
            </div>
            <div class="flex flex-1 justify-end gap-4 items-center">
              <button onclick="window.location.href='finance.html'"
                class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
                <span class="truncate">Managemnt Money</span>
              </button>
              <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" id="currentUserAvatar"
                data-alt="User avatar"
                style='background-image: url("https://ui-avatars.com/api/?name=User&background=random");'></div>
            </div>
          </header>

          <main class="flex-1 mt-8">
            <!-- HeroSection -->
            <div class="@container bg-surface-light dark:bg-surface-dark p-6 sm:p-8 rounded-xl">
              <div class="flex flex-col gap-6 @[864px]:flex-row @[864px]:items-center">
                <div class="flex flex-col gap-6 @[480px]:gap-8 @[864px]:justify-center">
                  <div class="flex flex-col gap-2 text-left">
                    <h1
                      class="text-text-light-primary dark:text-text-dark-primary text-4xl font-black leading-tight tracking-[-0.033em] @[480px]:text-5xl">
                      Settle up with everyone.</h1>
                    <h2
                      class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-normal leading-normal @[480px]:text-base">
                      Effortlessly calculate the simplest way to clear all your balances across all groups in just a few
                      clicks.</h2>
                  </div>
                  <button id="recordBtn"
                    class="flex w-full sm:w-auto max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
                    <span class="truncate">Record Settlement</span>
                  </button>
                </div>
                <div
                  class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl @[480px]:h-auto @[480px]:min-w-[400px] @[864px]:w-full"
                  data-alt="Abstract gradient illustration"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCasFrT3IzI1ZEzxm6w2hk4z8Rd1kpf1toAiCsi8dXXnqyfd2mjnzb4_8_V9kDfIBYndApVjBTKVrxqO_p5ZkLiQusmZ1qQ_9Fj5RxxqfgdZqDK7KjXMndRnBtC6VD2o5yFteKtBciM9Vu54FRLdku4ZZzyiC_94knCJO1BxE8lfwpugwP02diuD0sUFVzQd3DonpkhIf0_mnfLvee4wKhsQ3832OSCy6aCsugUPylzIJHVR_K30_EJFXdXF-OOYidYcPDL9vNJ1sm8");'>
                </div>
              </div>
            </div>

            <!-- Summary Statistics Section -->
            <h2
              class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold leading-tight tracking-[-0.015em] px-2 pb-3 pt-10">
              Summary Statistics</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              <div
                class="flex flex-col gap-4 rounded-xl p-6 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark">
                <div class="flex items-center justify-between">
                  <p class="text-text-light-primary dark:text-text-dark-primary text-base font-medium leading-normal">
                    Total You Owe</p>
                  <div class="p-2 rounded-full bg-negative/20 text-negative">
                    <span class="material-symbols-outlined text-base">arrow_downward</span>
                  </div>
                </div>
                <p class="text-text-light-primary dark:text-text-dark-primary tracking-tight text-4xl font-bold leading-tight text-negative"
                  id="totalOwed">0.00 MAD</p>
              </div>
              <div
                class="flex flex-col gap-4 rounded-xl p-6 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark">
                <div class="flex items-center justify-between">
                  <p class="text-text-light-primary dark:text-text-dark-primary text-base font-medium leading-normal">
                    Total You Are Owed</p>
                  <div class="p-2 rounded-full bg-positive/20 text-positive">
                    <span class="material-symbols-outlined text-base">arrow_upward</span>
                  </div>
                </div>
                <p class="text-text-light-primary dark:text-text-dark-primary tracking-tight text-4xl font-bold leading-tight text-positive"
                  id="totalLent">0.00 MAD</p>
              </div>
              <div
                class="flex flex-col gap-4 rounded-xl p-6 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark">
                <div class="flex items-center justify-between">
                  <p class="text-text-light-primary dark:text-text-dark-primary text-base font-medium leading-normal">
                    Net Balance</p>
                  <div class="p-2 rounded-full bg-primary/20 text-primary">
                    <span class="material-symbols-outlined text-base">account_balance_wallet</span>
                  </div>
                </div>
                <p class="text-text-light-primary dark:text-text-dark-primary tracking-tight text-4xl font-bold leading-tight text-positive"
                  id="netBalance">0.00 MAD</p>
              </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-10">
              <!-- Left Column: Friend Balances -->
              <div class="lg:col-span-1 flex flex-col gap-4">
                <div class="flex justify-between items-center px-2">
                  <h2
                    class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold leading-tight tracking-[-0.015em]">
                    Friend Balances</h2>
                  <span class="text-sm text-text-light-secondary" id="friendCount">0 friends</span>
                </div>

                <div class="flex flex-col gap-3" id="balancesCards">
                  <!-- JS Populated -->
                  <div class="text-center py-4 text-text-light-secondary">Loading balances...</div>
                </div>
              </div>

              <!-- Right Column: Tables -->
              <div class="lg:col-span-2 flex flex-col gap-8">
                <!-- Suggested Global Settlements -->
                <div class="flex flex-col gap-4">
                  <div class="flex justify-between items-center px-2">
                    <h2
                      class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold leading-tight tracking-[-0.015em]">
                      Suggested Settlements</h2>
                    <span class="text-sm text-text-light-secondary" id="settlementCount">0 suggestions</span>
                  </div>

                  <div
                    class="overflow-x-auto bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark">
                    <table class="w-full text-left text-sm" id="settlementsTable">
                      <thead
                        class="bg-background-light dark:bg-background-dark text-text-light-secondary dark:text-text-dark-secondary uppercase text-xs">
                        <tr>
                          <th class="px-6 py-4 font-medium" scope="col">Payer</th>
                          <th class="px-6 py-4 font-medium" scope="col">Payee</th>
                          <th class="px-6 py-4 font-medium text-right" scope="col">Amount</th>
                          <th class="px-6 py-4 font-medium text-center" scope="col">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- JS Populated -->
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Global Settlement History -->
                <div class="flex flex-col gap-4">
                  <div class="flex justify-between items-center px-2">
                    <h2
                      class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold leading-tight tracking-[-0.015em]">
                      Settlement History</h2>
                    <span class="text-sm text-text-light-secondary" id="historyCount">0 records</span>
                  </div>

                  <div
                    class="overflow-x-auto bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark">
                    <table class="w-full text-left text-sm" id="historyTable">
                      <thead
                        class="bg-background-light dark:bg-background-dark text-text-light-secondary dark:text-text-dark-secondary uppercase text-xs">
                        <tr>
                          <th class="px-6 py-4 font-medium" scope="col">Date</th>
                          <th class="px-6 py-4 font-medium" scope="col">From</th>
                          <th class="px-6 py-4 font-medium" scope="col">To</th>
                          <th class="px-6 py-4 font-medium text-right" scope="col">Amount</th>
                          <th class="px-6 py-4 font-medium text-center" scope="col">Status</th>
                          <th class="px-6 py-4 font-medium text-center" scope="col">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- JS Populated -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </main>
        </div>
      </div>
    </div>
  </div>

  <!-- Record Global Settlement Modal -->
  <div id="recordSettlementModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div
      class="w-full max-w-lg rounded-xl bg-surface-light dark:bg-surface-dark p-6 sm:p-8 shadow-2xl flex flex-col gap-6 transform scale-95 transition-transform duration-300"
      id="modalContent">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-text-light-primary dark:text-text-dark-primary">Record Global Settlement</h3>
        <button onclick="closeSettlementModal()"
          class="text-text-light-secondary dark:text-text-dark-secondary hover:text-text-light-primary dark:hover:text-text-dark-primary transition-colors">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <form class="flex flex-col gap-6" id="settlementForm">
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary"
            for="payerDisplay">Who Paid?</label>
          <input type="text" value="You" readonly
            class="w-full rounded-md border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light-primary dark:text-text-dark-primary opacity-70 cursor-not-allowed">
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary"
            for="toUserSelect">Who was paid?</label>
          <select
            class="w-full rounded-md border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:border-primary focus:ring-primary text-text-light-primary dark:text-text-dark-primary"
            id="toUserSelect" required>
            <option value="">Select a friend...</option>
          </select>
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary"
            for="settleAmount">Amount</label>
          <input
            class="w-full rounded-md border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:border-primary focus:ring-primary text-text-light-primary dark:text-text-dark-primary"
            id="settleAmount" type="number" step="0.01" min="0.01" placeholder="0.00" required />
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary"
            for="settlementMessage">Message (Optional)</label>
          <textarea
            class="w-full rounded-md border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:border-primary focus:ring-primary text-text-light-primary dark:text-text-dark-primary"
            id="settlementMessage" rows="2" placeholder="Add a note..."></textarea>
        </div>

        <!-- Settlement Preview -->
        <div class="rounded-lg bg-primary/10 dark:bg-primary/20 p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="size-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">You</div>
            <span class="material-symbols-outlined text-primary">arrow_forward</span>
            <div class="size-10 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold"
              id="previewRecipientAvatar">?</div>
          </div>
          <div class="text-right">
            <p class="text-xs text-primary font-medium">You pay <span id="previewRecipientName">...</span></p>
            <p class="text-2xl font-bold text-primary" id="previewAmountDisplay">0.00 MAD</p>
          </div>
        </div>

        <!-- Hidden elements for compatibility with existing JS if needed, though I'll update JS -->
        <span id="previewAmountText" class="hidden"></span>
        <span id="previewRecipientText" class="hidden"></span>

        <div class="flex gap-3 pt-2">
          <button onclick="closeSettlementModal()"
            class="flex-1 h-11 flex items-center justify-center rounded-lg bg-background-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-sm font-bold text-text-light-primary dark:text-text-dark-primary hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            type="button">Cancel</button>
          <button
            class="flex-1 h-11 flex items-center justify-center rounded-lg bg-primary text-sm font-bold text-white hover:opacity-90 transition-opacity"
            type="submit">Confirm Settlement</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/global-balance.js"></script>

  <!-- Modal Logic -->
  <script>
    function closeSettlementModal() {
      const modal = document.getElementById('recordSettlementModal');
      const content = document.getElementById('modalContent');

      modal.classList.add('opacity-0', 'pointer-events-none');
      content.classList.remove('scale-100');
      content.classList.add('scale-95');
    }

    // Override the open logic in global-balance.js or add a helper
    function showTailwindModal() {
      const modal = document.getElementById('recordSettlementModal');
      const content = document.getElementById('modalContent');

      modal.classList.remove('opacity-0', 'pointer-events-none');
      content.classList.remove('scale-95');
      content.classList.add('scale-100');
    }

    // Update avatar on load
    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof fetchCurrentUser === 'function') {
        const user = await fetchCurrentUser();
        if (user) {
          const avatarEl = document.getElementById('currentUserAvatar');
          if (avatarEl) {
            const avatarUrl = user.profile_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=random`;
            avatarEl.style.backgroundImage = `url("${avatarUrl}")`;
          }
        }
      }
    });
  </script>
</body>

</html>